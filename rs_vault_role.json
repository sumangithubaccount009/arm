{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "7944106905432231543"
    }
  },
  "parameters": {
    "vaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Vault"
      }
    },
    "enableCRR": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable CRR (Works if vault has not registered any backup instance)"
      }
    },
    "vaultStorageType": {
      "type": "string",
      "defaultValue": "GeoRedundant",
      "allowedValues": [
        "LocallyRedundant",
        "GeoRedundant"
      ],
      "metadata": {
        "description": "Change Vault Storage Type (Works if vault has not registered any backup instance)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
"resourceGroupname": {
  "type": "string",
  "metadata": {
    "description": "description"
  }
},

     "tags": {
        "type": "object",
        "metadata": {
            "description": "description"
        }
    },
        "vnetName": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "subnet1Name": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "privateEndpointName": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },

               "Networkrg": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "builtInRoleType": {
            "type": "string",
            "allowedValues": [
                "Owner",
                "Contributor",
                "Reader"
            ],
            "metadata": {
                "description": "Built-in role to assign"
            }
        },
        "roleNameGuid": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "A new GUID used to identify the role assignment"
            }
        }
  },
  "functions": [],
  "variables": {
    "skuName": "RS0",
    "skuTier": "Standard",
    "Owner": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
    "Contributor": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
    "Reader": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"

  },
  "resources": [
    
    {
            "apiVersion": "2021-04-01",
            "name": "nestedTemplate",
            "type": "Microsoft.Resources/deployments",
            
              "resourceGroup":"[parameters('resourceGroupname')]",
          

            "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
      ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                      {
      "type": "Microsoft.RecoveryServices/vaults",
      
      "apiVersion": "2020-02-02",
      "name": "[parameters('vaultName')]",
      
       "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "[variables('skuName')]",
               "tier": "[variables('skuTier')]"
      },
      "identity": {
        "type": "SystemAssigned"
			
      },
      "properties": {}
    },
               {
      "type": "Microsoft.RecoveryServices/vaults/backupstorageconfig",
      "apiVersion": "2020-02-02",
      "name": "[format('{0}/{1}', parameters('vaultName'), 'vaultstorageconfig')]",
     
            "properties": {
        "StorageModelType": "[parameters('vaultStorageType')]",
        "CrossRegionRestoreFlag": "[parameters('enableCRR')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
      ]
    },
        {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2020-06-01",
      "name": "[parameters('privateEndpointName')]",
    
      "location": "[resourceGroup().location]",
      "tags": "[parameters('tags')]",
      "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]",
           
              "[resourceId('Microsoft.Authorization/roleAssignments', parameters('roleNameGuid'))]"
            ],
      "properties": {
        "subnet": {
          "id": "[resourceId(parameters('Networkrg'),'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name'))]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[parameters('privateEndpointName')]", 
             "resourceGroup": "[parameters('resourceGroupname')]",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]",
              "groupIds": [
                "AzureBackup"
              ],
              "privateLinkServiceConnectionState": {
                                "status": "Approved",
                                "description": "Auto-Approved",
                                "actionsRequired": "None"
                            }
            
            }
          }
        ]
      }
    }  



                    ]
                }
            }
    },
    {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-09-01-preview",
            "name": "[parameters('roleNameGuid')]",
           "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
           
          
            ],


            "properties": {
                "roleDefinitionId": "[variables(parameters('builtInRoleType'))]",
                "principalId":"[reference(resourceId('dd19b834-04a0-419e-a41f-659229794569',parameters('resourceGroupname'),'Microsoft.RecoveryServices/vaults', parameters('vaultName')), '2021-10-01', 'full').identity.principalId]"
            }
        }



  ]
}